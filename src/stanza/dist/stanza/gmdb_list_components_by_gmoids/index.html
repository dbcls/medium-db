

<script src="../assets/js/stanza.js"></script>
<script>
  (function() {
    const descriptor = {"templates":{"stanza.html":"{{#if error}}{{#if msg}}\n  \u003cp\u003e{{msg}}\u003c/p\u003e\n{{/if}}{{/if}}\n\n{{#unless error}}\n  \u003ch2\u003e\n    Querying components with gmo_id:\n    {{#each result.query}}\n      \u003cspan\u003e{{this}}\u003c/span\u003e\n    {{/each}}\n  \u003c/h2\u003e\n{{/unless}}\n\n"},"parameters":["gmo_ids"],"elementName":"togostanza-gmdb_list_components_by_gmoids","development":false};

    if ('Promise' in window && 'URLSearchParams' in window && 'fetch' in window) {
      const Stanza = TogoStanza.initialize(descriptor);

      Stanza(function(stanza, params){

  const api_url = "http://ep.dbcls.jp/sparqlist/api/";
  const api_name = "gmdb_media_by_taxid";
  const queryKey = "gmo_ids";
  const data = {};
  //
  let msg = "";
  let error = false;
  let q;


  if(!params[queryKey]){
    q = new Promise((resolve, error) => {
      error(`No Parameter. ${queryKey} (e.g. XXXXXXX) is required`);
    });
  }else{
    q = fetch(`${api_url}${api_name}`, makeOptions(params));
  }


  q.then(res => res.json())
    .then(json => success(json))
    .catch(error => fail(error))
    .finally(() => {
      stanza.render({
        template: "stanza.html",
        parameters: {
          result: data,
          msg: msg,
          error: error
        }
      });
    });

  function success(json){
    if(json.length === 0){
      throw new Error(`Not found. ${queryKey}: ${params[queryKey]}`);
    }

    data.query = params[queryKey]
      .split(",")
      .map(str => `${str.trim()}`)
      .filter(str => !!str);
  }

  function fail(e){
    error = true;
    if(e.toString().match(/No Parameter/) !== null){
      msg = ``;
    }else{
      msg = `${e}`;
    }
  }
});


function makeOptions(params){
  let formBody = [];

  for(let key in params){
    if(params[key]){
      const value = params[key]
        .split(",")
        .map(str => str.trim())
        .filter(str => !!str)
        .join(",");
      formBody.push(key + "=" + encodeURIComponent(value));
    }
  }

  return {
    method: "POST",
    mode: "cors",
    body: formBody.join("&"),
    headers: {
      "Accept": "application/json",
      "Content-Type": "application/x-www-form-urlencoded"
    }
  };
}

    } else {
      const element = document.querySelector(descriptor.elementName);

      element.innerHTML = "<p>Your Web browser does not support the features required for the stanza to work. If you are using Internet Explorer 11, placing the following snippet before loading webcomponents-loader.js may resolve this issue:</p>\n<pre><code>&lt;script src=\"https://cdn.jsdelivr.net/combine/npm/@babel/polyfill@7.2.5/dist/polyfill.min.js,npm/@ungap/url-search-params@0.1.2/min.js,npm/whatwg-fetch@3.0.0/dist/fetch.umd.js\" crossorigin&gt;&lt;/script&gt;</code></pre>";
    }
  })();
</script>
