

<script src="../assets/js/stanza.js"></script>
<script>
  (function() {
    const descriptor = {"templates":{"stanza.html":"{{#if error}}\n  \u003cp\u003e{{msg}}\u003c/p\u003e\n{{/if}}\n{{#unless error}}\n  \u003ctable\u003e\n    \u003cthead\u003e\n    \u003ctr\u003e\n      \u003cth\u003eID\u003c/th\u003e\n      \u003cth\u003eName\u003c/th\u003e\n      \u003c/th\u003e\n    \u003c/tr\u003e\n    \u003c/thead\u003e\n    {{#each result.body.media}}\n      \u003ctr\u003e\n        \u003ctd\u003e\n          \u003ca href=\"http://growthmedium.org/medium/{{gm_id}}\"\u003e{{gm_id}}\u003c/a\u003e\n        \u003c/td\u003e\n        \u003ctd\u003e{{label}}\u003c/td\u003e\n      \u003c/tr\u003e\n    {{/each}}\n  \u003c/table\u003e\n{{/unless}}\n\n\n"},"parameters":["tax_id"],"elementName":"togostanza-gmdb_media_by_taxid","development":false};

    if ('Promise' in window && 'URLSearchParams' in window && 'fetch' in window) {
      const Stanza = TogoStanza.initialize(descriptor);

      Stanza(function(stanza, params){

  const api_url = "http://ep.dbcls.jp/sparqlist/api/";
  const api_name = "gmdb_media_by_taxid";
  const options = makeOptions(params);
  const data = {};

  let msg = "";
  let error = false;

  if(!params["tax_id"]){
    error = true;
    msg = "tax_id (e.g. 203404) is required";
  }

  fetch(`${api_url}${api_name}`, options)
    .then(res => res.json())
    .then(json => success(json))
    .catch(error => fail(error))
    .finally(() => {
      stanza.render({
        template: "stanza.html",
        parameters: {
          result: data,
          msg: msg,
          error: error
        }
      });
    });

  function success(json){
    if(json.length === 0){
      error = true;
      msg = `Not found. tax_id: ${params["tax_id"]}`;
      return;
    }

    data.body = {};
    data.body.media = [];

    for(let i = 0; i < json.length; i++){
      data.body.media.push({
        "gm_id": json[i].gm_id,
        "uri": json[i].uri,
        "label": json[i].label
      });
    }
  }

  function fail(e){
    error = true;
    msg = `Server Error ${e}`;
  }
});


function makeOptions(params){
  let formBody = [];

  for(let key in params){
    if(params[key]){
      formBody.push(key + "=" + encodeURIComponent(params[key]));
    }
  }

  return {
    method: "POST",
    mode: "cors",
    body: formBody.join("&"),
    headers: {
      "Accept": "application/json",
      "Content-Type": "application/x-www-form-urlencoded"
    }
  };
}

    } else {
      const element = document.querySelector(descriptor.elementName);

      element.innerHTML = "<p>Your Web browser does not support the features required for the stanza to work. If you are using Internet Explorer 11, placing the following snippet before loading webcomponents-loader.js may resolve this issue:</p>\n<pre><code>&lt;script src=\"https://cdn.jsdelivr.net/combine/npm/@babel/polyfill@7.2.5/dist/polyfill.min.js,npm/@ungap/url-search-params@0.1.2/min.js,npm/whatwg-fetch@3.0.0/dist/fetch.umd.js\" crossorigin&gt;&lt;/script&gt;</code></pre>";
    }
  })();
</script>
